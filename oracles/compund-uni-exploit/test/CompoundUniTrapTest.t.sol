pragma solidity ^0.8.13;

import {Test, console} from "forge-std/Test.sol";
import {CompoundUniTrap} from "../src/CompoundUniTrap.sol";

contract CompoundUniTrapTest is Test {
    CompoundUniTrap public compoundUniTrap;
    uint256 public currentBlockNumber = 19290918;

    //The attack takes place at block 19290921

    //Defi Lab source
    //https://github.com/SunWeb3Sec/DeFiHackLabs/blob/main/src/test/2024-02/CompoundUni_exp.sol
    //https://etherscan.io/tx/0xaee0f8d1235584a3212f233b655f87b89f22f1d4890782447c4ef742b37af58d

     uint256[10] public forks;

    function setUp() public {
        compoundUniTrap = new CompoundUniTrap();

        for (uint256 i = 0; i < 10; i++) {
            console.log("Setting for block number: ",currentBlockNumber + i);
            forks[i] = vm.createSelectFork(vm.rpcUrl("https://mainnet.infura.io/v3/39b2abffe10e4659a12074ce9a344bae"), currentBlockNumber + i);
        }
    }

    function testContinuousMonitoring() public {
        for (uint256 i = 0; i < 10; i++) {
            console.log("Block Number:",currentBlockNumber + forks[i]);
            CompoundUniTrap.PriceDataPoint[] memory prices = new CompoundUniTrap.PriceDataPoint[](1);
            vm.selectFork(forks[i]);

            prices[0] = compoundUniTrap.collect();

            bool valid = compoundUniTrap.isValid(prices);
            if (!valid) {
                console.log("Price deviation detected at block: ", currentBlockNumber + i);
                break;
            }
        }
    }
}